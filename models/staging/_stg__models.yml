version: 2

models:
  # ============================================================
  # STAGING — Type casting, cleaning, business logic
  # ============================================================
  - name: stg_weather
    description: "Hourly weather observations for Montreal from Open-Meteo API"
    columns:
      - name: observation_time
        tests: [not_null]
      - name: observation_date
        tests: [not_null]
      - name: observation_hour
        tests:
          - not_null
      - name: temperature_c
        tests: [not_null]
      - name: weather_category
        tests:
          - not_null
          - accepted_values:
              values: ['Clear', 'Cloudy', 'Fog', 'Drizzle', 'Rain', 'Snow', 'Rain Showers', 'Snow Showers', 'Thunderstorm', 'Unknown']

  - name: stg_routes
    description: "GTFS route definitions with type casting"
    columns:
      - name: route_id
        tests: [not_null, unique]
      - name: route_type
        tests:
          - not_null
          - accepted_values:
              values: [1, 3]

  - name: stg_stops
    description: "GTFS stop locations with GPS coordinates"
    columns:
      - name: stop_id
        tests: [not_null, unique]
      - name: stop_lat
        tests: [not_null]
      - name: stop_lon
        tests: [not_null]

  - name: stg_vehicle_positions
    description: "Real-time bus positions cleaned with UTC→Montreal timezone conversion"
    columns:
      - name: bus_id
        tests: [not_null]
      - name: event_timestamp
        tests: [not_null]
      - name: latitude
        tests: [not_null]
      - name: longitude
        tests: [not_null]
      - name: route_id
        tests: [not_null]
      - name: event_date
        tests: [not_null]
      - name: event_hour
        tests: [not_null]

  - name: stg_trips
    description: "GTFS trip definitions with route and service references"
    columns:
      - name: trip_id
        tests: [not_null, unique]
      - name: route_id
        tests: [not_null]
      - name: service_id
        tests: [not_null]

  - name: stg_stop_times
    description: "GTFS scheduled stop times per trip"
    columns:
      - name: trip_id
        tests: [not_null]
      - name: stop_id
        tests: [not_null]
      - name: stop_sequence
        tests: [not_null]

  - name: stg_calendar
    description: "GTFS service calendar with day-of-week flags"
    columns:
      - name: service_id
        tests: [not_null, unique]
      - name: start_date
        tests: [not_null]
      - name: end_date
        tests: [not_null]

  - name: stg_calendar_dates
    description: "GTFS calendar exceptions (added/removed service)"
    columns:
      - name: service_id
        tests: [not_null]
      - name: exception_date
        tests: [not_null]
      - name: exception_type
        tests:
          - not_null
          - accepted_values:
              values: [1, 2]

  - name: stg_shapes
    description: "GTFS route geometry points"
    columns:
      - name: shape_id
        tests: [not_null]
      - name: shape_pt_lat
        tests: [not_null]
      - name: shape_pt_lon
        tests: [not_null]
      - name: shape_pt_sequence
        tests: [not_null]

  - name: stg_agency
    description: "GTFS transit agency info"
    columns:
      - name: agency_id
        tests: [not_null]

  # ============================================================
  # SILVER — Dimension and Fact tables (star schema)
  # ============================================================
  - name: dim_routes
    description: "Route dimension — single source of truth for route attributes"
    columns:
      - name: route_id
        tests: [not_null, unique]
      - name: route_short_name
        tests: [not_null]
      - name: route_type_desc
        tests:
          - not_null
          - accepted_values:
              values: ['Subway/Metro', 'Bus']

  - name: dim_stops
    description: "Stop dimension with GPS coordinates"
    columns:
      - name: stop_id
        tests: [not_null, unique]

  - name: dim_calendar
    description: "Calendar dimension with service pattern classification"
    columns:
      - name: service_id
        tests: [not_null, unique]
      - name: service_pattern
        tests:
          - accepted_values:
              values: ['Weekday', 'Weekend', 'Daily', 'Custom']

  - name: dim_date
    description: "Date dimension generated from 2025-01-01 to 2026-12-31"
    columns:
      - name: date_key
        tests: [not_null, unique]
      - name: weekday_label
        tests:
          - not_null
          - accepted_values:
              values: ['Weekday', 'Weekend']

  - name: fact_vehicle_positions
    description: "Deduplicated vehicle positions with dimension keys"
    columns:
      - name: bus_id
        tests: [not_null]
      - name: event_timestamp
        tests: [not_null]
      - name: route_id
        tests:
          - not_null
          - relationships:
              to: ref('dim_routes')
              field: route_id
              severity: warn

  - name: fact_trips
    description: "Trips enriched with route context and direction labels"
    columns:
      - name: trip_id
        tests: [not_null, unique]
      - name: route_id
        tests:
          - not_null
          - relationships:
              to: ref('dim_routes')
              field: route_id
      - name: direction_label
        tests:
          - accepted_values:
              values: ['Outbound', 'Inbound']

  - name: fact_stop_times
    description: "Stop times denormalized with stop/trip/route context"
    columns:
      - name: trip_id
        tests: [not_null]
      - name: stop_id
        tests:
          - not_null
          - relationships:
              to: ref('dim_stops')
              field: stop_id

  # ============================================================
  # GOLD — Analytics tables (additive measures for BI)
  # ============================================================
  - name: fct_daily_performance
    description: "Daily route performance with weather — additive measures only"
    columns:
      - name: event_date
        tests:
          - not_null
          - relationships:
              to: ref('dim_date')
              field: date_key
      - name: route_id
        tests:
          - not_null
          - relationships:
              to: ref('dim_routes')
              field: route_id
              severity: warn
      - name: total_positions
        description: "Count of GPS pings — additive"
        tests: [not_null]
      - name: overcrowded_count
        description: "Positions with standing or full status — additive"
        tests: [not_null]
      - name: dominant_weather
        tests:
          - not_null
          - accepted_values:
              values: ['Clear', 'Cloudy', 'Fog', 'Drizzle', 'Rain', 'Snow', 'Rain Showers', 'Snow Showers', 'Thunderstorm', 'Unknown']

  - name: fct_fleet_optimization
    description: "Daily fleet optimization metrics per route — additive measures, ratios computed in DAX"
    columns:
      - name: event_date
        tests:
          - not_null
          - relationships:
              to: ref('dim_date')
              field: date_key
      - name: route_id
        tests:
          - not_null
          - relationships:
              to: ref('dim_routes')
              field: route_id
              severity: warn
      - name: total_positions
        tests: [not_null]
      - name: overcrowded_count
        tests: [not_null]
      - name: underused_count
        tests: [not_null]
      - name: dominant_weather
        tests:
          - not_null
          - accepted_values:
              values: ['Clear', 'Cloudy', 'Fog', 'Drizzle', 'Rain', 'Snow', 'Rain Showers', 'Snow Showers', 'Thunderstorm', 'Unknown']
      - name: day_type
        tests:
          - not_null
          - accepted_values:
              values: ['Weekday', 'Weekend']

  - name: fct_occupancy_by_hour
    description: "Hourly occupancy per route per day — additive measures for heatmap drill-down"
    columns:
      - name: event_date
        tests:
          - not_null
          - relationships:
              to: ref('dim_date')
              field: date_key
      - name: route_id
        tests:
          - not_null
          - relationships:
              to: ref('dim_routes')
              field: route_id
              severity: warn
      - name: event_hour
        tests: [not_null]
      - name: total_positions
        tests: [not_null]
      - name: overcrowded_count
        tests: [not_null]
      - name: time_period
        tests:
          - not_null
          - accepted_values:
              values: ['AM Peak', 'PM Peak', 'Off Peak']

  - name: fct_route_analytics
    description: "Route-level GTFS schedule statistics — trip counts, stop coverage"
    columns:
      - name: route_id
        tests:
          - not_null
          - unique
          - relationships:
              to: ref('dim_routes')
              field: route_id
              severity: warn
      - name: total_trips
        tests: [not_null]
      - name: total_stops
        tests: [not_null]

  - name: obt_positions_wide
    description: "One Big Table — every position with route + weather joined for ad-hoc BI queries"
    columns:
      - name: bus_id
        tests: [not_null]
      - name: event_timestamp
        tests: [not_null]
      - name: route_id
        tests: [not_null]
      - name: event_date
        tests: [not_null]
